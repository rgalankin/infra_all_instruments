---
id: 20260224150200-03
title: "Мониторинг PostgreSQL"
summary: >
  Операционное руководство по мониторингу PostgreSQL: disk usage, connections, slow queries,
  deadlocks, replication lag. Скрипты для Beget, USA серверов.
type: process
status: active
tags: [eng/database, eng/monitoring, process/runbook, platform/postgresql]
source: roman
ai_weight: normal
created: 2026-02-24
updated: 2026-02-24
---
# МОНИТОРИНГ POSTGRESQL

## ОБЗОР

Ключевые метрики для мониторинга:
1. **Disk usage** — свободное место (критично, если <10%)
2. **Connections** — количество подключений vs max_connections
3. **Slow queries** — запросы >1 секунды
4. **Deadlocks** — блокировки
5. **Replication lag** — если используется репликация (пока нет)

## DISK USAGE

### Проверка диска (хост)

**Beget:**
```bash
ssh roman@82.202.129.193
df -h /opt/infra/volumes/postgres

# Вывод:
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/vda1        50G   12G   36G  25% /
```

**USA (после deployment):**
```bash
ssh roman@149.33.4.37
df -h /opt/documentoved/volumes/postgres
```

### Проверка внутри контейнера

```bash
docker exec postgres df -h /var/lib/postgresql/data
```

### Проверка размера БД

```sql
SELECT pg_database.datname,
       pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
```

**Пример вывода:**
```
     datname      |  size
------------------+---------
 credoserv_chat   | 1200 MB
 n8n              | 450 MB
 telegram_stories | 150 MB
 ebk              | 50 MB
```

### Размер таблиц

```sql
-- Подключиться к БД
\c credoserv_chat

-- Размеры таблиц
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

### Alert при disk >80%

**Скрипт:**
```bash
#!/bin/bash
# /opt/infra/scripts/check-postgres-disk.sh

THRESHOLD=80
DISK_USAGE=$(df -h /opt/infra/volumes/postgres | tail -1 | awk '{print $5}' | sed 's/%//')

if [ "$DISK_USAGE" -gt "$THRESHOLD" ]; then
  echo "ALERT: PostgreSQL disk usage is ${DISK_USAGE}% (threshold: ${THRESHOLD}%)"

  # Отправить в B24
  curl -X POST "https://x-credoserv.bitrix24.ru/rest/44/WEBHOOK/im.notify" \
    -d "to=1&message=ALERT: PostgreSQL disk usage is ${DISK_USAGE}%! Threshold: ${THRESHOLD}%"
fi
```

**Cron (каждый час):**
```bash
0 * * * * /opt/infra/scripts/check-postgres-disk.sh >> /var/log/postgres-disk-check.log 2>&1
```

## CONNECTIONS

### Текущие подключения

```sql
SELECT count(*) AS current_connections
FROM pg_stat_activity;

-- Лимит
SELECT setting AS max_connections
FROM pg_settings
WHERE name = 'max_connections';
```

**Пример:**
```
 current_connections
---------------------
                  15

 max_connections
-----------------
             200
```

### Подключения по БД

```sql
SELECT datname, count(*) AS connections
FROM pg_stat_activity
GROUP BY datname
ORDER BY connections DESC;
```

### Подключения по пользователям

```sql
SELECT usename, count(*) AS connections
FROM pg_stat_activity
GROUP BY usename
ORDER BY connections DESC;
```

### Активные запросы

```sql
SELECT pid, usename, datname, state, query_start,
       now() - query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;
```

### Kill зависшего подключения

```sql
-- Найти PID зависшего запроса
SELECT pid, query FROM pg_stat_activity WHERE state = 'active';

-- Убить подключение (осторожно!)
SELECT pg_terminate_backend(12345);  -- заменить 12345 на реальный PID
```

### Alert при connections >80% max

**Скрипт:**
```bash
#!/bin/bash
# /opt/infra/scripts/check-postgres-connections.sh

MAX=$(docker exec postgres psql -U postgres -t -c "SELECT setting FROM pg_settings WHERE name = 'max_connections';")
CURRENT=$(docker exec postgres psql -U postgres -t -c "SELECT count(*) FROM pg_stat_activity;")

THRESHOLD=$((MAX * 80 / 100))

if [ "$CURRENT" -gt "$THRESHOLD" ]; then
  echo "ALERT: PostgreSQL connections: $CURRENT / $MAX (threshold: $THRESHOLD)"

  curl -X POST "https://x-credoserv.bitrix24.ru/rest/44/WEBHOOK/im.notify" \
    -d "to=1&message=ALERT: PostgreSQL connections: $CURRENT / $MAX"
fi
```

## SLOW QUERIES

### Включить pg_stat_statements

**Один раз при настройке:**
```sql
-- Подключиться как superuser
\c postgres

-- Создать расширение
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

**Настроить postgresql.conf:**
```bash
# В docker-compose.yml добавить параметры:
command:
  - "postgres"
  - "-c"
  - "shared_preload_libraries=pg_stat_statements"
  - "-c"
  - "pg_stat_statements.track=all"
```

**Перезапустить PostgreSQL:**
```bash
docker-compose restart postgres
```

### Топ-10 медленных запросов

```sql
SELECT
    calls,
    total_exec_time / 1000 AS total_time_sec,
    mean_exec_time / 1000 AS avg_time_sec,
    query
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

### Запросы выполняющиеся сейчас >1 сек

```sql
SELECT pid, usename, datname,
       now() - query_start AS duration,
       query
FROM pg_stat_activity
WHERE state = 'active'
  AND now() - query_start > interval '1 second'
ORDER BY duration DESC;
```

### Сброс статистики (если нужно)

```sql
SELECT pg_stat_statements_reset();
```

## DEADLOCKS И БЛОКИРОВКИ

### Текущие блокировки

```sql
SELECT
    locktype,
    database,
    relation::regclass,
    mode,
    granted,
    pid
FROM pg_locks
WHERE NOT granted
ORDER BY pid;
```

### Deadlock count

```sql
SELECT datname, deadlocks
FROM pg_stat_database
WHERE datname IS NOT NULL
ORDER BY deadlocks DESC;
```

### Waiting queries (ждут блокировки)

```sql
SELECT
    blocked.pid AS blocked_pid,
    blocked.usename AS blocked_user,
    blocked.query AS blocked_query,
    blocker.pid AS blocker_pid,
    blocker.usename AS blocker_user,
    blocker.query AS blocker_query
FROM pg_stat_activity AS blocked
JOIN pg_locks AS blocked_locks ON blocked.pid = blocked_locks.pid
JOIN pg_locks AS blocker_locks ON blocked_locks.locktype = blocker_locks.locktype
    AND blocked_locks.database IS NOT DISTINCT FROM blocker_locks.database
    AND blocked_locks.relation IS NOT DISTINCT FROM blocker_locks.relation
    AND blocked_locks.page IS NOT DISTINCT FROM blocker_locks.page
    AND blocked_locks.tuple IS NOT DISTINCT FROM blocker_locks.tuple
    AND blocked_locks.virtualxid IS NOT DISTINCT FROM blocker_locks.virtualxid
    AND blocked_locks.transactionid IS NOT DISTINCT FROM blocker_locks.transactionid
    AND blocked_locks.classid IS NOT DISTINCT FROM blocker_locks.classid
    AND blocked_locks.objid IS NOT DISTINCT FROM blocker_locks.objid
    AND blocked_locks.objsubid IS NOT DISTINCT FROM blocker_locks.objsubid
    AND blocked_locks.pid != blocker_locks.pid
JOIN pg_stat_activity AS blocker ON blocker.pid = blocker_locks.pid
WHERE NOT blocked_locks.granted;
```

## CACHE HIT RATIO

**Цель:** >99% (если ниже, увеличить shared_buffers)

```sql
SELECT
    sum(heap_blks_read) AS heap_read,
    sum(heap_blks_hit) AS heap_hit,
    sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) AS ratio
FROM pg_statio_user_tables;
```

**Интерпретация:**
- ratio >0.99 (99%) — отлично
- ratio 0.90-0.99 — нормально
- ratio <0.90 — увеличить shared_buffers

## VACUUM И AUTOVACUUM

### Последний vacuum

```sql
SELECT schemaname, tablename,
       last_vacuum, last_autovacuum,
       last_analyze, last_autoanalyze
FROM pg_stat_user_tables
ORDER BY last_autovacuum DESC NULLS LAST;
```

### Dead tuples (строки для очистки)

```sql
SELECT schemaname, tablename,
       n_live_tup, n_dead_tup,
       round(n_dead_tup * 100.0 / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_pct
FROM pg_stat_user_tables
WHERE n_dead_tup > 0
ORDER BY n_dead_tup DESC;
```

**Если dead_pct >10%** — запустить VACUUM вручную:
```sql
VACUUM ANALYZE tablename;
```

## КОМПЛЕКСНЫЙ HEALTH CHECK

**Скрипт:**
```bash
#!/bin/bash
# /opt/infra/scripts/postgres-health-check.sh

echo "=== PostgreSQL Health Check ==="
echo "Date: $(date)"
echo

echo "--- Disk Usage ---"
df -h /opt/infra/volumes/postgres | tail -1

echo
echo "--- Database Sizes ---"
docker exec postgres psql -U postgres -c "
  SELECT datname, pg_size_pretty(pg_database_size(datname)) AS size
  FROM pg_database
  WHERE datname NOT IN ('template0', 'template1')
  ORDER BY pg_database_size(datname) DESC;
"

echo
echo "--- Connections ---"
docker exec postgres psql -U postgres -c "
  SELECT count(*) AS current,
         (SELECT setting FROM pg_settings WHERE name = 'max_connections') AS max
  FROM pg_stat_activity;
"

echo
echo "--- Active Queries ---"
docker exec postgres psql -U postgres -c "
  SELECT count(*) AS active_queries
  FROM pg_stat_activity
  WHERE state = 'active';
"

echo
echo "--- Cache Hit Ratio ---"
docker exec postgres psql -U postgres -c "
  SELECT round(sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)), 4) AS cache_hit_ratio
  FROM pg_statio_user_tables;
"

echo
echo "--- Dead Tuples ---"
docker exec postgres psql -U postgres -c "
  SELECT count(*) AS tables_with_dead_tuples
  FROM pg_stat_user_tables
  WHERE n_dead_tup > 100;
"

echo
echo "=== Health Check Completed ==="
```

**Запуск:**
```bash
bash /opt/infra/scripts/postgres-health-check.sh
```

**Cron (ежедневно в 9:00):**
```bash
0 9 * * * /opt/infra/scripts/postgres-health-check.sh | mail -s "PostgreSQL Health Report" admin@credoserv.ru
```

## МОНИТОРИНГ ЧЕРЕЗ GRAFANA (TODO)

**Будущее улучшение:**
1. Поднять Prometheus + Postgres Exporter
2. Настроить Grafana dashboard
3. Метрики: disk, connections, slow queries, cache hit ratio
4. Alerts в Telegram/B24

**Ссылки:**
- Postgres Exporter: https://github.com/prometheus-community/postgres_exporter
- Grafana Dashboard: https://grafana.com/grafana/dashboards/9628

## LINKS (INTERNAL)

- [[_index__20260224150000-01|Базы данных — реестр]]
- [[postgres-beget__20260224150100-01|PostgreSQL Beget Russia]]
- [[postgres-usa__20260224150100-02|PostgreSQL ISHosting USA]]
- [[connect-guide__20260224150200-01|Подключение к PostgreSQL]]
- [[backup-restore__20260224150200-02|Бэкапы и восстановление]]

## REFS (EXTERNAL)

- PostgreSQL Monitoring: https://www.postgresql.org/docs/current/monitoring-stats.html
- pg_stat_statements: https://www.postgresql.org/docs/current/pgstatstatements.html

## ИСТОРИЯ

- 2026-02-24: Создано руководство по мониторингу PostgreSQL. Скрипты health check.
