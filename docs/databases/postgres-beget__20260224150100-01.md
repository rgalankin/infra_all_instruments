---
id: 20260224150100-01
title: "PostgreSQL Beget Russia"
summary: >
  Production PostgreSQL сервер на VPS Beget. Docker-контейнер postgres:16-alpine.
  4 БД: n8n, credoserv_chat, telegram_stories, ebk. Критичность HIGH.
type: spec
status: active
tags: [eng/infrastructure, eng/database, platform/postgresql, platform/docker]
source: roman
ai_weight: high
created: 2026-02-24
updated: 2026-02-24
criticality: high
---
# POSTGRESQL BEGET RUSSIA

## ОСНОВНАЯ ИНФОРМАЦИЯ

| Параметр | Значение |
|----------|----------|
| Сервер | VPS Beget Russia |
| IP | 82.202.129.193 |
| Порт | 5432 (доступен только через 127.0.0.1, внешне закрыт) |
| Версия | PostgreSQL 16 (postgres:16-alpine) |
| Расположение | /opt/infra/compose/postgres |
| Docker сеть | net_internal |
| Критичность | HIGH |

## БАЗЫ ДАННЫХ

| База | Назначение | Критичность | Владелец | Схема |
|------|-----------|-------------|----------|-------|
| **n8n** | n8n workflow metadata, execution logs | HIGH | postgres | автоматическая (n8n) |
| **credoserv_chat** | CreditWise Chat: OAuth, users, conversations, messages | HIGH | postgres | см. ниже |
| **telegram_stories** | Telegram Stories pipeline: посты, транскрипции, аналитика | MEDIUM | postgres | см. ниже |
| **ebk** | Legacy проект (назначение неизвестно) | LOW | postgres | неизвестно |

## DOCKER COMPOSE

**Путь конфигурации:** `/opt/infra/compose/postgres/`

**Ключевые настройки:**
```yaml
services:
  postgres:
    image: ${POSTGRES_IMAGE}  # postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB_NAME}  # credoserv_chat (default)
      POSTGRES_USER: ${POSTGRES_USER}   # postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: ${SERVER_TIMEZONE}
    volumes:
      - ${VOLUME_POSTGRES}:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/10-init-db.sql:ro
      - ./install-extensions.sql:/docker-entrypoint-initdb.d/20-install-extensions.sql:ro
    ports:
      - "127.0.0.1:5432:5432"  # только localhost
    networks:
      - net_internal
    restart: unless-stopped
```

**Ресурсные лимиты:**
- CPU: 0.5 cores (limit), 0.1 cores (reservation)
- Memory: 512MB (limit), 256MB (reservation)

**Параметры PostgreSQL:**
- max_connections: 200
- shared_buffers: 256MB

## СХЕМЫ БД

### credoserv_chat
**Назначение:** CreditWise Chat backend (OAuth, диалоги, сообщения)

**Таблицы:**
- `users` — пользователи (email, phone, avatar, активность)
- `oauth_accounts` — OAuth-аккаунты (VK, Yandex, Sber)
- `conversations` — диалоги пользователя
- `messages` — сообщения (user/assistant/system)

**Расширения:**
- uuid-ossp (UUID generation)
- citext (case-insensitive text)
- pg_trgm (trigram search)

**Исходный код схемы:**
`/opt/infra/compose/postgres/credoserv_chat_schema.sql`

### telegram_stories
**Назначение:** Pipeline видео → Telegram Stories

**Таблицы:**
- `telegram_story_posts` — видео-посты (Google Drive → ASR → публикация → аналитика)

**Поля:**
- gdrive_file_id/name
- asr_job_id, transcript_file_url
- status: inbox → transcribed → scheduled → published → analytics_collected
- telegram_story_id, views_count, viewers_snapshot

**Исходный код схемы:**
`/opt/infra/compose/postgres/telegram_stories_001.sql`

### ebk
**Статус:** Неизвестно. Требуется аудит (возможно legacy, можно удалить).

## ПОДКЛЮЧЕНИЕ

### Из localhost VPS Beget
```bash
psql -h 127.0.0.1 -U postgres -d credoserv_chat
```

### Из удалённой машины (через SSH tunnel)
```bash
# Создать туннель
ssh -L 15432:127.0.0.1:5432 roman@82.202.129.193

# В новом терминале
psql -h 127.0.0.1 -p 15432 -U postgres -d credoserv_chat
```

### pgAdmin
Через SSH tunnel (настроить SSH connection в pgAdmin):
- SSH Host: 82.202.129.193
- SSH User: roman
- PostgreSQL Host: 127.0.0.1
- PostgreSQL Port: 5432

## БЭКАПЫ

### Автоматические
**Механизм:** Docker volume snapshots через Beget панель управления

**Параметры:**
- Частота: ежедневно (3:00 AM MSK)
- Хранение: 7 дней
- Объём: ~2 GB (все 4 БД)

**Последний бэкап:** 2026-02-23 03:00

### Ручные (pg_dump)
```bash
# Дамп одной БД
docker exec postgres pg_dump -U postgres credoserv_chat > credoserv_chat_$(date +%Y%m%d).sql

# Дамп всех БД
docker exec postgres pg_dumpall -U postgres > all_databases_$(date +%Y%m%d).sql

# Восстановление
docker exec -i postgres psql -U postgres -d credoserv_chat < backup.sql
```

## МОНИТОРИНГ

### Диск
```bash
# На хосте
df -h /opt/infra/volumes/postgres

# Внутри контейнера
docker exec postgres df -h /var/lib/postgresql/data
```

### Подключения
```sql
SELECT count(*) FROM pg_stat_activity;
SELECT max_connections FROM pg_settings WHERE name = 'max_connections';
```

### Slow queries
```sql
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;
```

## ОПЕРАЦИОННЫЕ TODO

- [ ] Протестировать восстановление из бэкапа (DR drill)
- [ ] Настроить alert при disk usage > 80%
- [ ] Исследовать ebk БД (используется или можно удалить?)
- [ ] Включить pg_stat_statements для анализа slow queries
- [ ] Создать ERD-диаграммы для credoserv_chat и telegram_stories

## LINKS (INTERNAL)

- [[_index__20260224150000-01|Базы данных — реестр]]
- [[connect-guide__20260224150200-01|Подключение к PostgreSQL]]
- [[backup-restore__20260224150200-02|Бэкапы и восстановление]]
- [[monitoring__20260224150200-03|Мониторинг БД]]
- [[infra_all_instruments/docs/infrastructure/vps-beget__20260210220200-01|VPS Beget]]

## ИСТОРИЯ

- 2026-02-24: Создана карточка PostgreSQL Beget. Инвентаризация 4 БД.
