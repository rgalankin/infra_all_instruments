---
id: 20260224150200-01
title: "Подключение к PostgreSQL — руководство"
summary: >
  Операционное руководство по подключению к PostgreSQL серверам: psql, pgAdmin, SSH tunnels,
  docker exec. Для всех трёх серверов: Beget, USA, Mac.
type: process
status: active
tags: [eng/database, process/runbook, platform/postgresql]
source: roman
ai_weight: normal
created: 2026-02-24
updated: 2026-02-24
---
# ПОДКЛЮЧЕНИЕ К POSTGRESQL

## ОБЗОР

Все PostgreSQL серверы настроены с доступом только через localhost (127.0.0.1) для безопасности. Удалённое подключение требует SSH tunnel.

## ПОДКЛЮЧЕНИЕ К BEGET RUSSIA

**Сервер:** 82.202.129.193
**Базы:** n8n, credoserv_chat, telegram_stories, ebk

### Вариант 1: SSH + psql на сервере
```bash
# Подключиться к VPS
ssh roman@82.202.129.193

# psql через localhost
psql -h 127.0.0.1 -U postgres -d credoserv_chat
# Пароль: см. /opt/infra/compose/postgres/.env
```

### Вариант 2: SSH tunnel + psql локально
```bash
# Терминал 1: создать туннель
ssh -L 15432:127.0.0.1:5432 roman@82.202.129.193 -N

# Терминал 2: подключиться через туннель
psql -h 127.0.0.1 -p 15432 -U postgres -d credoserv_chat
```

**Алиас для туннеля (добавить в ~/.zshrc):**
```bash
alias pg-beget='ssh -L 15432:127.0.0.1:5432 roman@82.202.129.193 -N'
```

### Вариант 3: docker exec на сервере
```bash
ssh roman@82.202.129.193

# Через docker exec (без пароля)
docker exec -it postgres psql -U postgres -d credoserv_chat
```

### Вариант 4: pgAdmin через SSH tunnel

**Настройка SSH Tunnel в pgAdmin:**
1. Создать новый сервер (Add New Server)
2. Вкладка **General:**
   - Name: `Beget Russia`
3. Вкладка **Connection:**
   - Host: `127.0.0.1`
   - Port: `5432`
   - Maintenance database: `postgres`
   - Username: `postgres`
   - Password: (см. /opt/infra/compose/postgres/.env)
4. Вкладка **SSH Tunnel:**
   - Use SSH tunneling: ✅
   - Tunnel host: `82.202.129.193`
   - Tunnel port: `22`
   - Username: `roman`
   - Authentication: `Identity file` (выбрать ~/.ssh/id_rsa или ключ Beget)

## ПОДКЛЮЧЕНИЕ К ISHOSTING USA

**Сервер:** 149.33.4.37
**Статус:** Планируется (задача #1022)

После deployment процедура будет аналогична Beget:

```bash
# SSH tunnel
ssh -L 25432:127.0.0.1:5432 roman@149.33.4.37 -N

# psql
psql -h 127.0.0.1 -p 25432 -U postgres -d documentoved_contacts
```

**Алиас:**
```bash
alias pg-usa='ssh -L 25432:127.0.0.1:5432 roman@149.33.4.37 -N'
```

## ПОДКЛЮЧЕНИЕ К MAC DOCKER

**Сервер:** localhost (Docker Desktop)
**Базы:** drive_ml, n8n

### Вариант 1: psql напрямую
```bash
psql -h 127.0.0.1 -U admin -d drive_ml
# Пароль: см. /Users/mac/Documents/documentoved/.env
```

### Вариант 2: docker exec
```bash
docker exec -it drive_postgres psql -U admin -d drive_ml
```

### Вариант 3: pgAdmin
Запустить pgAdmin через docker-compose:
```bash
cd /Users/mac/Documents/documentoved
docker-compose --profile tools up -d pgadmin
```

Открыть: http://localhost:5050
- Email: admin@example.com
- Password: admin

**Добавить сервер:**
1. Servers → Add New Server
2. General → Name: `Mac Local`
3. Connection:
   - Host: `host.docker.internal` (для доступа к хост-машине из Docker)
   - Port: `5432`
   - Username: `admin`
   - Password: (из .env)

## ОБЩИЕ КОМАНДЫ psql

### Список БД
```sql
\l
```

### Подключиться к другой БД
```sql
\c database_name
```

### Список таблиц
```sql
\dt
```

### Описание таблицы
```sql
\d table_name
```

### Выход
```sql
\q
```

### Размер БД
```sql
SELECT pg_database.datname,
       pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
ORDER BY pg_database_size(pg_database.datname) DESC;
```

### Список подключений
```sql
SELECT pid, usename, application_name, client_addr, state, query
FROM pg_stat_activity
WHERE datname = current_database();
```

## БЕЗОПАСНОСТЬ

### Правила
1. Никогда не открывать PostgreSQL порт 5432 публично (только 127.0.0.1)
2. Использовать сильные пароли (32+ символов, сгенерированные)
3. SSH-доступ только по ключам (пароли отключены)
4. Пароли БД хранить в .env файлах (не в репозитории)
5. Для production использовать SSH tunnels, не прямой доступ

### Где хранятся пароли
- **Beget:** `/opt/infra/compose/postgres/.env` (на сервере)
- **USA:** `/opt/documentoved/postgres/.env` (после deployment)
- **Mac:** `/Users/mac/Documents/documentoved/.env`

**ВАЖНО:** Пароли не коммитить в git. Использовать .gitignore:
```
.env
*.env
```

## TROUBLESHOOTING

### "Connection refused" при SSH tunnel
**Причина:** PostgreSQL не слушает на 127.0.0.1 или Docker контейнер не запущен

**Решение:**
```bash
# Проверить статус Docker контейнера
docker ps | grep postgres

# Запустить контейнер
docker start postgres

# Проверить порт на сервере
ssh roman@82.202.129.193 "netstat -tlnp | grep 5432"
```

### "Password authentication failed"
**Причина:** Неверный пароль или пользователь

**Решение:**
```bash
# Проверить переменные в .env
cat /opt/infra/compose/postgres/.env

# Или использовать docker exec (без пароля)
docker exec -it postgres psql -U postgres
```

### "Could not translate host name to address"
**Причина:** Неверный хост или порт

**Решение:**
- Для remote подключений использовать `127.0.0.1`, не `localhost`
- Проверить что SSH tunnel запущен (ps aux | grep ssh)

## LINKS (INTERNAL)

- [[_index__20260224150000-01|Базы данных — реестр]]
- [[postgres-beget__20260224150100-01|PostgreSQL Beget Russia]]
- [[postgres-usa__20260224150100-02|PostgreSQL ISHosting USA]]
- [[postgres-mac__20260224150100-03|PostgreSQL Mac Docker]]
- [[backup-restore__20260224150200-02|Бэкапы и восстановление]]

## ИСТОРИЯ

- 2026-02-24: Создано руководство по подключению к PostgreSQL (все 3 сервера).
