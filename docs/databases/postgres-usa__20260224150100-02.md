---
id: 20260224150100-02
title: "PostgreSQL ISHosting USA"
summary: >
  PostgreSQL сервер на VPS ISHosting USA (149.33.4.37). Статус: планируется deployment
  для Documentoved проекта. Задача B24 #1022.
type: spec
status: active
tags: [eng/infrastructure, eng/database, platform/postgresql, platform/docker]
source: roman
ai_weight: normal
created: 2026-02-24
updated: 2026-02-24T19:30:00
criticality: high
---
# POSTGRESQL ISHOSTING USA

## ОСНОВНАЯ ИНФОРМАЦИЯ

| Параметр | Значение |
|----------|----------|
| Сервер | VPS ISHosting USA |
| IP | 149.33.4.37 |
| Порт | 5432 (localhost only, внешне закрыт) |
| Версия | PostgreSQL 16.12 |
| Контейнер | hub-postgres |
| Docker сеть | hub_internal |
| Пользователь | documentoved |
| Основная БД | drive_ml |
| Критичность | HIGH |
| Статус | **PRODUCTION** — PostgreSQL развёрнут, данные мигрированы |

## НАЗНАЧЕНИЕ

Сервер для проекта **Documentoved** (двухсерверная архитектура: backend ISHosting USA, frontend другой сервер).

**Развёрнутые БД:**
1. **drive_ml** — контакты (26 записей), документы, file registry, ML модели
2. **n8n_usa** — n8n workflow state для автоматизаций
3. **credoserv_chat** — история сообщений чат-маршрутизатора
4. **ai_agents** — данные AI-агентов
5. **wa_autoresponder** — WhatsApp автоответчик

## АРХИТЕКТУРА DOCUMENTOVED

**Двухсерверная модель:**
- **Backend (ISHosting USA):** PostgreSQL + n8n + API
- **Frontend (TBD):** веб-интерфейс, Telegram-бот

**Почему отдельный сервер PostgreSQL:**
- Изоляция критичных данных (контакты, финансы)
- Соответствие требованиям IS Smart (безопасность данных)
- Масштабируемость (бэкапы, read-replicas)

## DEPLOYMENT (выполнено 2026-02-24)

### 1. Контейнер PostgreSQL
**Контейнер:** hub-postgres
**Image:** postgres:16.12
**Пользователь:** hub_admin (superuser), documentoved (owner drive_ml)
**Volume:** hub_pgdata → /var/lib/postgresql/data
**Ports:** 127.0.0.1:5432:5432 (localhost only)

### 2. База drive_ml
**Owner:** documentoved
**Encoding:** UTF8
**Таблицы:**
- contacts (26 записей, 88 колонок)
- contact_documents
- file_registry
- folder_stats
- kb_notes
- ml_model
- processing_log
- triage_rules
- user_actions

**Структура contacts:** полная поддержка банкротства (долги, кредиторы, имущество, дела ФССП), финансы (доходы, расходы, семья), интеграция B24.

**Миграция:** выполнена 2026-02-24 с Mac БД (26 контактов).

### 3. Бэкапы
**Скрипт:** /srv/backups/backup-postgres.sh
**Расположение:** /srv/backups/postgres/
**Периодичность:** ежедневно в 3:00 UTC (cron)
**Retention:** 7 дней
**Типы:**
- drive_ml_YYYYMMDD_HHMMSS.sql.gz (основная БД)
- all_databases_YYYYMMDD_HHMMSS.sql.gz (все БД)

**Последний бэкап:**
- drive_ml: 25MB
- all_databases: 29MB

### 4. Мониторинг
**Ежедневный health check:**
```bash
ssh roman@149.33.4.37 'docker exec hub-postgres psql -U documentoved -d drive_ml -c "SELECT COUNT(*) FROM contacts;"'
```

**Disk usage:**
```bash
ssh roman@149.33.4.37 'du -sh /var/lib/docker/volumes/hub_pgdata/'
```

## ПОДКЛЮЧЕНИЕ

**Из localhost VPS ISHosting:**
```bash
docker exec -it hub-postgres psql -U documentoved -d drive_ml
```

**Из удалённой машины (SSH tunnel):**
```bash
ssh -L 15432:127.0.0.1:5432 roman@149.33.4.37
# В другом терминале:
psql -h 127.0.0.1 -p 15432 -U documentoved -d drive_ml
```

**Password:** хранится в Docker container environment (POSTGRES_PASSWORD)

## БЕЗОПАСНОСТЬ

- [x] PostgreSQL доступен только через 127.0.0.1 (не публично)
- [x] Firewall: порт 5432 заблокирован извне (только localhost)
- [x] Сильный пароль hub_admin (24 символа)
- [x] Бэкапы локальные (7 дней retention)
- [x] SSH-доступ только по ключам (пароли отключены)
- [ ] TODO: S3 бэкапы для disaster recovery

## ЗАВИСИМОСТИ

**Задача #1022:** Развёртывание PostgreSQL ISHosting USA
**Блокирует:** Documentoved backend development

**Результаты выполнения (2026-02-24):**
- [x] PostgreSQL 16.12 развёрнут в контейнере hub-postgres
- [x] База drive_ml создана с полной схемой (9 таблиц)
- [x] 26 контактов мигрированы с Mac БД
- [x] Бэкапы настроены (ежедневно в 3:00 UTC, retention 7 дней)
- [x] Скрипт бэкапа: /srv/backups/backup-postgres.sh
- [x] Структура таблицы contacts синхронизирована (88 колонок)
- [x] Индексы созданы (performance)
- [x] Триггеры настроены (updated_at auto-update)

## TODO

- [ ] Настроить S3 бэкапы для disaster recovery (Cloudflare R2 или AWS S3)
- [ ] Настроить мониторинг (Grafana + Prometheus)
- [ ] Документировать ERD-диаграмму drive_ml
- [ ] Протестировать restore из бэкапа на тестовом окружении
- [ ] Настроить алерты на disk usage >80%

## LINKS (INTERNAL)

- [[_index__20260224150000-01|Базы данных — реестр]]
- [[connect-guide__20260224150200-01|Подключение к PostgreSQL]]
- [[backup-restore__20260224150200-02|Бэкапы и восстановление]]
- [[infra_all_instruments/docs/infrastructure/vps-ishosting-usa__20260212220200-01|VPS ISHosting USA]]

## REFS (EXTERNAL)

- Documentoved архитектура: см. проект infra_vps_usa/docs/context__20260120123758.md
- IS Smart требования: безопасность данных контактов

## ИСТОРИЯ

- 2026-02-24T15:00: Создана карточка PostgreSQL USA (задача B24 #1022)
- 2026-02-24T19:25: Миграция структуры таблицы contacts (88 колонок)
- 2026-02-24T19:26: Миграция 26 контактов с Mac БД
- 2026-02-24T19:28: Настройка бэкапов (cron 3:00 UTC, retention 7 дней)
- 2026-02-24T19:30: Deployment завершён успешно. Статус: PRODUCTION
