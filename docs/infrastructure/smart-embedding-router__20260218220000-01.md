---
id: smart-embedding-router__20260218220000-01
title: "Smart Embedding Router --- стратегия free tier стэкинга"
summary: "Архитектура роутера для embedding-запросов: failover между провайдерами, подсчёт токенов, максимизация бесплатного использования"
type: reference
status: active
tags: [ai/embedding, infra/architecture, process/optimization, ai/rag]
source: ai-research
ai_weight: high
created: 2026-02-18
updated: 2026-02-18
---
# Smart Embedding Router --- стратегия free tier стэкинга

## Концепция

Smart Embedding Router --- это архитектурный паттерн, позволяющий максимизировать бесплатное использование embedding API путём:

1. **Стэкинга free tier** --- регистрация на всех провайдерах с бесплатными квотами
2. **Failover-маршрутизации** --- автоматическое переключение между провайдерами при исчерпании квот
3. **Подсчёта токенов** --- трекинг использования для каждого провайдера
4. **Приоритизации** --- выбор провайдера по стоимости, скорости и доступности

---

## Архитектура роутера

```
[Embedding Request]
        |
        v
  [Token Counter]  --- подсчёт токенов в запросе
        |
        v
  [Provider Selector] --- выбор провайдера по приоритету
        |
   +---------+---------+---------+---------+
   |         |         |         |         |
   v         v         v         v         v
[Scaleway] [DashScope] [DeepInfra] [SiliconFlow] [Fireworks]
(free:1M)  (free:2M)  (free:36M)  (free:20M)   (free:10M)
   |         |         |         |         |
   +----+----+----+----+----+----+----+----+
        |              |
        v              v
   [OpenRouter]   [Ollama Local]
   ($0.01/1M)     (бесплатно, fallback)
```

### Логика выбора провайдера

1. **Первый приоритет --- провайдеры с невыгорающими квотами:**
   - Scaleway (1M навсегда)
   - Ollama (локально, бесконечно)

2. **Второй приоритет --- провайдеры с большими стартовыми кредитами:**
   - DeepInfra ($1.80 = ~36M токенов)
   - SiliconFlow ($1 = ~20M токенов)
   - Fireworks AI ($1 = ~10M токенов)

3. **Третий приоритет --- провайдеры с ограниченным free tier:**
   - DashScope Beijing (1M, 90 дней)
   - DashScope Singapore (1M, 90 дней)

4. **Fallback --- самый дешёвый платный:**
   - OpenRouter/Nebius ($0.01/1M)

---

## Маршруты из России

### Доступные напрямую

| Провайдер | Регион | Доступность из РФ | Примечание |
|-----------|--------|:-----------------:|-----------|
| DashScope Beijing | Китай | Прямой доступ | Нужен китайский номер |
| DashScope Singapore | Сингапур | Прямой доступ | Международная карта |
| Scaleway | Франция | Прямой доступ | EU карта для пополнения |
| SiliconFlow | Китай | Прямой доступ | Нужен китайский номер |
| Ollama | Локально | Локально | Свой сервер/ПК |

### Требуют US VPS / VPN

| Провайдер | Причина блокировки | Решение |
|-----------|-------------------|---------|
| DeepInfra | Гео-ограничение для РФ | Через US VPS (ISHosting) |
| Fireworks AI | Гео-ограничение для РФ | Через US VPS (ISHosting) |
| OpenRouter | Гео-ограничение для РФ | Через US VPS (ISHosting) |

> **Рекомендация:** Для провайдеров, требующих US VPS, использовать ISHosting USA VPS как egress proxy. API-запросы маршрутизируются через VPS, ответы возвращаются напрямую.

---

## Подсчёт токенов и лимитов

### Сводная таблица free tier

| # | Провайдер | Бесплатно токенов | Срок | Статус квоты |
|:-:|-----------|:-----------------:|:----:|:------------:|
| 1 | Scaleway | 1M | Навсегда | Постоянная |
| 2 | DashScope Beijing | 1M | 90 дней | Истекает |
| 3 | DashScope Singapore | 1M | 90 дней | Истекает |
| 4 | DeepInfra | ~36M | Пока не кончатся | Разовая |
| 5 | SiliconFlow | ~20M | Пока не кончатся | Разовая |
| 6 | Fireworks AI | ~10M | Пока не кончатся | Разовая |
| 7 | Ollama | бесконечно | Навсегда | Постоянная |
| **ИТОГО** | | **~69M + бесконечно локально** | | |

### Трекинг использования

Для каждого провайдера необходимо отслеживать:
- `total_tokens_used` --- общее количество использованных токенов
- `free_quota_remaining` --- остаток бесплатной квоты
- `quota_expires_at` --- дата истечения квоты (для DashScope)
- `last_request_at` --- время последнего запроса (для rate limiting)
- `error_count` --- количество ошибок (для failover)

---

## Стратегия стэкинга: 69M бесплатных токенов

### Порядок регистрации

1. **Scaleway** --- зарегистрироваться первым (1M навсегда, не истекает)
2. **DeepInfra** --- без карты, $1.80 кредитов, самый большой free tier для Qwen3
3. **SiliconFlow** --- $1 кредитов, также бесплатный BGE-M3
4. **Fireworks AI** --- $1 кредитов, карта не нужна сразу
5. **DashScope Singapore** --- 1M на 90 дней, международная карта
6. **DashScope Beijing** --- 1M на 90 дней, нужен китайский номер (по возможности)

### Порядок использования (расходования)

1. Начинать с **DashScope** (истекающие квоты --- использовать первыми)
2. Затем **DeepInfra** (самый большой запас, ~36M)
3. Затем **SiliconFlow** (~20M)
4. Затем **Fireworks AI** (~10M)
5. **Scaleway** --- экономить, использовать для штучных запросов (навсегда)
6. **Ollama** --- fallback для тяжёлых задач (если есть GPU)
7. **OpenRouter** --- платный fallback ($0.01/1M)

---

## Расчёт: на сколько хватит 69M токенов

### Базовые метрики

- 1 страница текста (A4) ~ 500 слов ~ 700 токенов (русский)
- 1 чанк RAG (512 токенов) ~ 350 слов
- 1 поисковый запрос ~ 20-50 токенов

### Сценарии использования

| Сценарий | Объём | Токенов | Хватит на |
|----------|-------|:-------:|-----------|
| **Базовый RAG** | 100 документов по 10 стр. | ~700K | ~99 проектов |
| **Расширенный RAG** | 1000 документов по 10 стр. | ~7M | ~10 проектов |
| **Интенсивный RAG** | 10000 документов по 10 стр. | ~70M | ~1 проект |
| **Семантический поиск** | 10K запросов/мес | ~500K/мес | ~11 лет |
| **Индексация KB** | 500 статей по 5 стр. | ~1.75M | ~39 индексаций |
| **Реиндексация (ежемесячная)** | 500 статей/мес | ~1.75M/мес | ~39 месяцев |

### Вывод

Для типичного проекта малого бизнеса (несколько сотен документов, умеренный поиск) 69M бесплатных токенов хватит на **1-3 года** без каких-либо расходов.

---

## Рекомендации по выбору провайдера для конкретных задач

| Задача | Рекомендуемый провайдер | Почему |
|--------|------------------------|--------|
| RAG для внутренних документов | DeepInfra / SiliconFlow | Большие квоты, хорошая скорость |
| Семантический поиск (production) | OpenRouter ($0.01/1M) | Самый дешёвый платный, стабильный |
| Пакетная индексация | DeepInfra | Большая квота, нет жёстких rate limits |
| Штучные запросы / тестирование | Scaleway | 1M навсегда, без истечения |
| Чувствительные данные | Ollama (локально) | Данные не покидают сервер |
| Edge / мобильные | Cloudflare Workers AI (0.6B) | Бесплатно, быстро, но модель маленькая |
| Мультиязычный поиск | DashScope | Оригинальный провайдер, лучшая совместимость |

---

## Блокировки и санкции: анализ рисков

### Матрица рисков по провайдерам

| Провайдер | Юрисдикция | Риск блокировки из РФ | Риск санкций | Комментарий |
|-----------|-----------|:---------------------:|:------------:|-----------|
| DashScope Beijing | Китай | Низкий | Низкий | Китай не участвует в санкциях против РФ |
| DashScope Singapore | Сингапур | Низкий | Низкий | Сингапур нейтрален, Alibaba --- китайская компания |
| Scaleway | Франция/EU | Средний | Средний | EU --- может ввести ограничения; пока работает |
| DeepInfra | США | Высокий | Высокий | Гео-блок уже есть; нужен US VPS |
| SiliconFlow | Китай | Низкий | Низкий | Китайская компания, нет ограничений для РФ |
| Fireworks AI | США | Высокий | Высокий | Гео-блок уже есть; нужен US VPS |
| OpenRouter | США | Высокий | Высокий | Гео-блок уже есть; нужен US VPS |
| Ollama | Локально | Нет | Нет | Данные не покидают сервер |

### Стратегия минимизации рисков

1. **Критичные данные** --- только через Ollama (локально) или китайские провайдеры
2. **Диверсификация** --- не зависеть от одного провайдера; всегда иметь 2-3 резервных
3. **US VPS как прокси** --- для DeepInfra, Fireworks, OpenRouter использовать ISHosting USA
4. **Китайские провайдеры как опора** --- DashScope и SiliconFlow наименее подвержены санкционным рискам
5. **Бэкап через Ollama** --- всегда иметь возможность переключиться на локальный инференс

### Что делать при блокировке провайдера

1. Роутер автоматически переключается на следующий по приоритету
2. Ollama --- fallback, работает всегда (если есть GPU)
3. Для пользователей без GPU --- BGE-M3 через Novita AI / SiliconFlow (бесплатно навсегда)
4. Переход на платный OpenRouter ($0.01/1M) через US VPS как крайняя мера

---

## Links (internal)

- [[infra_all_instruments/docs/neural-networks/cards/qwen3-embedding-8b__20260218210000-01|Карточка: Qwen3-Embedding-8B]]
- [[infra_all_instruments/docs/neural-networks/by-type/embedding__20260210220400-10|Embedding модели (индекс)]]
- [[infra_all_instruments/docs/neural-networks/cards/bge-m3__20260218190000-04|Карточка: BGE-M3]]
- [[infra_all_instruments/docs/infrastructure/vps-ishosting-usa__20260212220200-01|VPS ISHosting USA]]
- [[infra_all_instruments/docs/infrastructure/_index__20260210220000-03|Реестр инфраструктуры]]

## История

- **2026-02-18:** Создан документ: архитектура роутера, стратегия стэкинга, анализ рисков (ai-research)
